<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Project Planning Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">
/* ============================================================
   CONSTANTS
============================================================ */
const TASK_TYPES = ['Build', 'Testing', 'Training', 'Planning', 'Milestone'];
const DURATION_UNITS = ['Days', 'Weeks'];

/* ============================================================
   DATE UTILITIES (single source of truth)
============================================================ */
const isBusinessDay = d => d.getDay() !== 0 && d.getDay() !== 6;

function calculateProjectStart(goLive, weeks) {
  if (!goLive) return null;
  const d = new Date(goLive);
  let days = weeks * 5 - 1;
  while (days > 0) {
    d.setDate(d.getDate() - 1);
    if (isBusinessDay(d)) days--;
  }
  while (d.getDay() !== 1) d.setDate(d.getDate() - 1);
  return d;
}

function getMondayOfWeek(projectStart, week) {
  if (!projectStart) return null;
  const d = new Date(projectStart);
  let days = (week - 1) * 5;
  while (days > 0) {
    d.setDate(d.getDate() + 1);
    if (isBusinessDay(d)) days--;
  }
  return d;
}

function calculateEndDate(start, duration, unit) {
  const d = new Date(start);
  let days = unit === 'Weeks' ? duration * 5 : duration;
  let added = 0;
  while (added < days - 1) {
    d.setDate(d.getDate() + 1);
    if (isBusinessDay(d)) added++;
  }
  return d;
}

/* ============================================================
   EXCEL TEMPLATE (INTAKE)
============================================================ */
function downloadTemplate() {
  const wb = XLSX.utils.book_new();

  const lists = XLSX.utils.aoa_to_sheet([
    ['TaskTypes', ...TASK_TYPES],
    ['DurationUnits', ...DURATION_UNITS],
    ['YesNo', 'Yes', 'No']
  ]);
  lists['!hidden'] = 1;
  XLSX.utils.book_append_sheet(wb, lists, 'Lists');

  const ws = XLSX.utils.aoa_to_sheet([
    ['Project Planning Input Template'],
    [],
    ['Instructions:'],
    ['• One task per row'],
    ['• Do not rename columns'],
    ['• Use dropdowns only'],
    [],
    [
      'Task Name','Task Details','Start Week','Duration',
      'Duration Unit','Exact Date Required','Specific Date',
      'Task Type','Notes'
    ]
  ]);

  ws['!freeze'] = { ySplit: 8 };
  ws['!cols'] = [
    {wch:28},{wch:40},{wch:12},{wch:10},
    {wch:14},{wch:20},{wch:14},{wch:16},{wch:30}
  ];

  ws['!dataValidation'] = [
    { type:'list', sqref:'E9:E500', formula1:'=Lists!$B$2:$C$2' },
    { type:'list', sqref:'F9:F500', formula1:'=Lists!$B$3:$C$3' },
    { type:'list', sqref:'H9:H500', formula1:'=Lists!$B$1:$F$1' }
  ];

  XLSX.utils.book_append_sheet(wb, ws, 'Tasks');
  XLSX.writeFile(wb, 'project_tasks_template.xlsx');
}

/* ============================================================
   EXCEL EXPORT (POLISHED TRACKER)
============================================================ */
function exportExcel({ projectName, goLiveDate, projectWeeks, tasks }) {
  const wb = XLSX.utils.book_new();
  const rows = [];

  const projectStart = calculateProjectStart(goLiveDate, projectWeeks);

  rows.push(
    ['Project Name', projectName || ''],
    ['Go-Live Date', goLiveDate || ''],
    ['Project Duration', `${projectWeeks} weeks`],
    ['Project Start', projectStart?.toLocaleDateString() || ''],
    [],
  );

  const weekMap = {};
  tasks.forEach(t => {
    const start = t.specificDate
      ? new Date(t.specificDate)
      : getMondayOfWeek(projectStart, t.startWeek);
    const end = calculateEndDate(start, t.duration, t.durationUnit);

    if (!weekMap[t.startWeek]) weekMap[t.startWeek] = [];
    weekMap[t.startWeek].push({ ...t, start, end });
  });

  Object.keys(weekMap)
    .sort((a,b)=>a-b)
    .forEach(week => {
      const ws = getMondayOfWeek(projectStart, Number(week));
      const we = calculateEndDate(ws, 5, 'Days');

      rows.push([`WEEK ${week} (${ws.toLocaleDateString()} – ${we.toLocaleDateString()})`]);
      rows.push(['Task','Type','Start','End','Duration','% Complete','Notes']);

      weekMap[week]
        .sort((a,b)=>a.start-b.start || a.end-b.end)
        .forEach(t=>{
          rows.push([
            t.name,
            t.taskType,
            t.start.toLocaleDateString(),
            t.end.toLocaleDateString(),
            `${t.duration} ${t.durationUnit}`,
            t.percentComplete,
            t.notes
          ]);
        });

      rows.push([]);
    });

  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols'] = [
    {wch:30},{wch:14},{wch:12},{wch:12},
    {wch:14},{wch:12},{wch:40}
  ];
  ws['!freeze'] = { ySplit: 6 };

  XLSX.utils.book_append_sheet(wb, ws, 'Project Tracker');
  XLSX.writeFile(wb, `${projectName || 'project'}_tracker.xlsx`);
}

/* ============================================================
   REACT APP
============================================================ */
function App() {
  const { useState } = React;
  const [step,setStep]=useState(1);
  const [projectName,setProjectName]=useState('');
  const [goLiveDate,setGoLiveDate]=useState('');
  const [projectWeeks,setProjectWeeks]=useState(18);
  const [tasks,setTasks]=useState([]);

  function addTask(){
    setTasks(t=>[...t,{
      id:crypto.randomUUID(),
      name:'',details:'',startWeek:1,
      duration:1,durationUnit:'Weeks',
      exactDateRequired:false,specificDate:'',
      taskType:'Build',notes:'',
      owner:'',status:'Not Started',percentComplete:0
    }]);
  }

  function loadExcel(e){
    const r=new FileReader();
    r.onload=ev=>{
      const wb=XLSX.read(ev.target.result,{type:'array'});
      const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
      setTasks(rows.map(r=>({
        id:crypto.randomUUID(),
        name:r['Task Name']||'',
        details:r['Task Details']||'',
        startWeek:Number(r['Start Week'])||1,
        duration:Number(r['Duration'])||1,
        durationUnit:r['Duration Unit']||'Weeks',
        exactDateRequired:r['Exact Date Required']==='Yes',
        specificDate:r['Specific Date']||'',
        taskType:r['Task Type']||'Build',
        notes:r['Notes']||'',
        owner:'',status:'Not Started',percentComplete:0
      })));
      setStep(3);
    };
    r.readAsArrayBuffer(e.target.files[0]);
  }

  return (
    <div className="max-w-7xl mx-auto p-6">
      <div className="bg-white p-6 rounded-xl shadow">
        <h1 className="text-3xl font-bold mb-4">Project Planning Tool</h1>

        {step===1&&(
          <>
            <button onClick={downloadTemplate}
              className="bg-blue-600 text-white px-5 py-3 rounded">
              Download Excel Template
            </button>
            <button onClick={()=>setStep(2)}
              className="ml-4 bg-gray-700 text-white px-5 py-3 rounded">
              Next
            </button>
          </>
        )}

        {step===2&&(
          <input type="file" accept=".xlsx" onChange={loadExcel}/>
        )}

        {step===3&&(
          <>
            <div className="grid grid-cols-3 gap-4 mb-4">
              <input className="border p-2" placeholder="Project Name"
                value={projectName} onChange={e=>setProjectName(e.target.value)}/>
              <input type="date" className="border p-2"
                value={goLiveDate} onChange={e=>setGoLiveDate(e.target.value)}/>
              <input type="number" className="border p-2"
                value={projectWeeks} onChange={e=>setProjectWeeks(+e.target.value)}/>
            </div>

            {tasks.map(t=>(
              <div key={t.id} className="grid grid-cols-6 gap-2 mb-2">
                <input className="border p-1" value={t.name}
                  onChange={e=>t.name=e.target.value&&setTasks([...tasks])}/>
                <select className="border p-1" value={t.taskType}
                  onChange={e=>t.taskType=e.target.value&&setTasks([...tasks])}>
                  {TASK_TYPES.map(x=><option key={x}>{x}</option>)}
                </select>
                <input type="number" className="border p-1" value={t.startWeek}
                  onChange={e=>t.startWeek=+e.target.value&&setTasks([...tasks])}/>
                <input type="number" className="border p-1" value={t.duration}
                  onChange={e=>t.duration=+e.target.value&&setTasks([...tasks])}/>
                <select className="border p-1" value={t.durationUnit}
                  onChange={e=>t.durationUnit=e.target.value&&setTasks([...tasks])}>
                  {DURATION_UNITS.map(x=><option key={x}>{x}</option>)}
                </select>
                <button onClick={()=>setTasks(tasks.filter(x=>x!==t))}
                  className="text-red-600">✕</button>
              </div>
            ))}

            <button onClick={addTask}
              className="bg-green-600 text-white px-4 py-2 rounded mt-2">
              Add Task
            </button>

            <button onClick={()=>exportExcel({projectName,goLiveDate,projectWeeks,tasks})}
              className="ml-4 bg-blue-700 text-white px-4 py-2 rounded mt-2">
              Export to Excel
            </button>
          </>
        )}
      </div>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
