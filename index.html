<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Planning Tool</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef } = React;

    const ProjectPlannerTool = () => {
      const [step, setStep] = useState(1);
      const [projectName, setProjectName] = useState('');
      const [goLiveDate, setGoLiveDate] = useState('');
      const [projectWeeks, setProjectWeeks] = useState(18);
      const [tasks, setTasks] = useState([]);
      const [calendarFilter, setCalendarFilter] = useState('all');
      const fileInputRef = useRef(null);

      const taskTypes = ['Build', 'Testing', 'Training', 'Planning', 'Milestone'];

      const calculateProjectStart = (goLive, weeks) => {
        if (!goLive) return null;
        const date = new Date(goLive);
        let businessDays = (weeks * 5) - 1;
        while (businessDays > 0) {
          date.setDate(date.getDate() - 1);
          if (date.getDay() !== 0 && date.getDay() !== 6) businessDays--;
        }
        while (date.getDay() !== 1) date.setDate(date.getDate() - 1);
        return date;
      };

      const projectStartDate = calculateProjectStart(goLiveDate, projectWeeks);

      const getMondayOfWeek = (weekNum) => {
        if (!projectStartDate) return null;
        const date = new Date(projectStartDate);
        let businessDays = (weekNum - 1) * 5;
        while (businessDays > 0) {
          date.setDate(date.getDate() + 1);
          if (date.getDay() !== 0 && date.getDay() !== 6) businessDays--;
        }
        return date;
      };

      const calculateEndDate = (startDate, duration, durationType) => {
        const date = new Date(startDate);
        let daysToAdd = durationType === 'weeks' ? duration * 5 : duration;
        let added = 0;
        while (added < daysToAdd - 1) {
          date.setDate(date.getDate() + 1);
          if (date.getDay() !== 0 && date.getDay() !== 6) added++;
        }
        return date;
      };

      const downloadTemplate = () => {
        const templateData = [{
          'Task Name': 'Example Task',
          'Task Details': 'Description of the task',
          'Start Week': 1,
          'Duration': 2,
          'Duration Type': 'weeks',
          'Exact Date Required': 'No',
          'Task Type': 'Build'
        }];
        const ws = XLSX.utils.json_to_sheet(templateData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Tasks');
        XLSX.writeFile(wb, 'project_planning_template.xlsx');
      };

      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(sheet);
          const parsed = jsonData.map((row, i) => ({
            id: `task-${Date.now()}-${i}`,
            name: row['Task Name'] || '',
            details: row['Task Details'] || '',
            startWeek: parseInt(row['Start Week']) || 1,
            duration: parseFloat(row['Duration']) || 1,
            durationType: (row['Duration Type'] || 'weeks').toLowerCase(),
            exactDateRequired: (row['Exact Date Required'] || '').toLowerCase() === 'yes',
            taskType: row['Task Type'] || 'Build',
            specificDate: null,
            percentComplete: 0,
            notes: ''
          }));
          setTasks(parsed);
          setStep(3);
        };
        reader.readAsArrayBuffer(file);
      };

      const addTask = () => setTasks([...tasks, {
        id: `task-${Date.now()}`,
        name: '',
        details: '',
        startWeek: 1,
        duration: 1,
        durationType: 'weeks',
        exactDateRequired: false,
        taskType: 'Build',
        specificDate: null,
        percentComplete: 0,
        notes: ''
      }]);

      const updateTask = (id, field, value) => {
        setTasks(tasks.map(t => t.id === id ? { ...t, [field]: value } : t));
      };

      const deleteTask = (id) => setTasks(tasks.filter(t => t.id !== id));

      const saveProgress = () => {
        const data = { projectName, goLiveDate, projectWeeks, tasks };
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${projectName || 'project'}_progress.json`;
        a.click();
        URL.revokeObjectURL(url);
      };

      const loadProgress = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            setProjectName(data.projectName || '');
            setGoLiveDate(data.goLiveDate || '');
            setProjectWeeks(data.projectWeeks || 18);
            setTasks(data.tasks || []);
            setStep(4);
          } catch {
            alert('Error loading file. Please make sure it is a valid project file.');
          }
        };
        reader.readAsText(file);
      };

      const groupTasksByWeek = () => {
        const grouped = {};
        tasks.forEach(t => {
          if (!grouped[t.startWeek]) grouped[t.startWeek] = [];
          grouped[t.startWeek].push(t);
        });
        Object.keys(grouped).forEach(w => {
          grouped[w].sort((a, b) => {
            const aStart = a.specificDate ? new Date(a.specificDate) : getMondayOfWeek(a.startWeek);
            const bStart = b.specificDate ? new Date(b.specificDate) : getMondayOfWeek(b.startWeek);
            return calculateEndDate(aStart, a.duration, a.durationType) - 
                   calculateEndDate(bStart, b.duration, b.durationType);
          });
        });
        return grouped;
      };

      const exportToExcel = () => {
        const wb = XLSX.utils.book_new();

        const taskData = tasks.map(t => {
          const start = t.specificDate ? new Date(t.specificDate) : getMondayOfWeek(t.startWeek);
          const end = calculateEndDate(start, t.duration, t.durationType);
          return {
            'Week': `Week ${t.startWeek}`,
            'Task Type': t.taskType,
            'Task Name': t.name,
            'Details': t.details,
            'Start Date': start?.toLocaleDateString(),
            'End Date': end?.toLocaleDateString(),
            'Duration': `${t.duration} ${t.durationType}`,
            '% Complete': t.percentComplete,
            'Notes': t.notes
          };
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(taskData), 'Task Tracker');

        const gantt = tasks.map(t => {
          const start = t.specificDate ? new Date(t.specificDate) : getMondayOfWeek(t.startWeek);
          const end = calculateEndDate(start, t.duration, t.durationType);
          return {
            'Task': t.name,
            'Start': start?.toLocaleDateString(),
            'End': end?.toLocaleDateString(),
            'Type': t.taskType
          };
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(gantt), 'Gantt Chart');

        XLSX.writeFile(wb, `${projectName || 'project'}_tracker.xlsx`);
      };

      const renderCalendar = () => {
        if (!projectStartDate || !goLiveDate) return null;
        const filtered = calendarFilter === 'all' ? tasks : tasks.filter(t => t.taskType === calendarFilter);

        const endDate = new Date(goLiveDate);
        const days = [];
        let current = new Date(projectStartDate);
        while (current <= endDate) {
          days.push(new Date(current));
          current.setDate(current.getDate() + 1);
        }

        return (
          <div className="overflow-x-auto bg-white rounded-lg p-4 shadow-sm">
            <div className="flex border-b border-gray-300">
              {days.map((day, i) => (
                <div key={i} className="text-xs font-semibold text-center border-r border-gray-200 px-1">{day.getDate()}</div>
              ))}
            </div>
            <div className="relative" style={{ minHeight: filtered.length * 28 }}>
              {filtered.map((t, idx) => {
                const start = t.specificDate ? new Date(t.specificDate) : getMondayOfWeek(t.startWeek);
                const end = calculateEndDate(start, t.duration, t.durationType);
                const startIdx = days.findIndex(d => d >= start);
                const endIdx = days.findIndex(d => d >= end);
                const width = endIdx >= 0 && startIdx >= 0 ? endIdx - startIdx + 1 : 1;
                return startIdx >= 0 ? (
                  <div key={t.id} className="absolute top-[calc(var(--idx)*28px)] left-0 flex items-center"
                       style={{ '--idx': idx, left: `${startIdx*24}px`, width: `${width*24}px` }}>
                    <div className="bg-blue-500 text-white text-xs px-1 py-0.5 rounded truncate">{t.name}</div>
                  </div>
                ) : null;
              })}
            </div>
          </div>
        );
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-6">
          <div className="max-w-7xl mx-auto">
            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
              <div className="flex items-center justify-between mb-6">
                <h1 className="text-3xl font-bold text-gray-900">Project Planning Tool</h1>
                <div className="flex items-center gap-3">
                  <span className="text-sm text-gray-600">Step {step} of 6</span>
                  {step > 2 && (
                    <button onClick={saveProgress} className="flex items-center gap-2 px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                      üíæ Save Progress
                    </button>
                  )}
                </div>
              </div>

              {/* Step 1 - Download Template */}
              {step === 1 && (
                <div className="space-y-4">
                  <h2 className="text-xl font-bold text-gray-800">Getting Started</h2>
                  <p className="text-gray-600">Download the task template, fill your tasks, and upload it.</p>
                  <button onClick={downloadTemplate} className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">
                    ‚¨áÔ∏è Download Template
                  </button>
                </div>
              )}

              {/* Step 2 - Upload */}
              {step === 2 && (
                <div className="text-center space-y-4">
                  <h2 className="text-xl font-bold text-gray-800">Upload Your Data</h2>
                  <button onClick={() => fileInputRef.current?.click()}
                          className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">üìä Upload Task Spreadsheet</button>
                  <button onClick={() => document.getElementById('jsonUpload')?.click()}
                          className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition-colors">üìÅ Load Saved Project</button>
                  <input ref={fileInputRef} type="file" accept=".xlsx,.xls" onChange={handleFileUpload} className="hidden" />
                  <input id="jsonUpload" type="file" accept=".json" onChange={loadProgress} className="hidden" />
                </div>
              )}

              {/* Step 3 - Project Details */}
              {step === 3 && (
                <div className="space-y-3">
                  <label className="block text-sm font-semibold text-gray-700">Project Name</label>
                  <input type="text" value={projectName} onChange={(e) => setProjectName(e.target.value)}
                         className="w-full px-2 py-1 border rounded text-sm focus:ring-1 focus:ring-blue-500" />
                  <label className="block text-sm font-semibold text-gray-700">Go-Live Date</label>
                  <input type="date" value={goLiveDate} onChange={(e) => setGoLiveDate(e.target.value)}
                         className="w-full px-2 py-1 border rounded text-sm focus:ring-1 focus:ring-blue-500" />
                  <label className="block text-sm font-semibold text-gray-700">Project Duration (Weeks)</label>
                  <input type="number" value={projectWeeks} onChange={(e) => setProjectWeeks(parseInt(e.target.value) || 18)}
                         className="w-full px-2 py-1 border rounded text-sm focus:ring-1 focus:ring-blue-500" min="1" />
                  {projectStartDate && (
                    <p className="text-sm text-blue-900 mt-2"><strong>Project Start:</strong> {projectStartDate.toLocaleDateString()}</p>
                  )}
                </div>
              )}

              {/* Step 4 - Task Editing */}
              {step === 4 && (
                <div className="space-y-2">
                  <h2 className="text-xl font-bold text-gray-800">Review and Edit Tasks</h2>
                  {Object.entries(groupTasksByWeek()).sort(([a], [b]) => parseInt(a) - parseInt(b)).map(([week, weekTasks]) => (
                    <div key={week} className="bg-gray-50 rounded p-2">
                      <h3 className="text-sm font-semibold mb-1">Week {week}</h3>
                      {weekTasks.map(t => (
                        <div key={t.id} className="bg-white p-2 rounded mb-1 shadow-sm">
                          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 mb-1">
                            <div>
                              <label className="text-xs font-semibold">Task Name</label>
                              <input type="text" value={t.name} onChange={(e)=>updateTask(t.id,'name',e.target.value)} className="w-full px-2 py-1 border rounded text-sm"/>
                            </div>
                            <div>
                              <label className="text-xs font-semibold">Task Type</label>
                              <select value={t.taskType} onChange={(e)=>updateTask(t.id,'taskType',e.target.value)} className="w-full px-2 py-1 border rounded text-sm">
                                {taskTypes.map(type=><option key={type}>{type}</option>)}
                              </select>
                            </div>
                            <div>
                              <label className="text-xs font-semibold">% Complete</label>
                              <input type="number" value={t.percentComplete} onChange={(e)=>updateTask(t.id,'percentComplete',parseInt(e.target.value)||0)} min="0" max="100" className="w-full px-2 py-1 border rounded text-sm"/>
                            </div>
                            <div>
                              <label className="text-xs font-semibold">Duration</label>
                              <input type="number" value={t.duration} onChange={(e)=>updateTask(t.id,'duration',parseFloat(e.target.value)||1)} className="w-full px-2 py-1 border rounded text-sm"/>
                            </div>
                            <div>
                              <label className="text-xs font-semibold">Duration Type</label>
                              <select value={t.durationType} onChange={(e)=>updateTask(t.id,'durationType',e.target.value)} className="w-full px-2 py-1 border rounded text-sm">
                                <option value="days">days</option>
                                <option value="weeks">weeks</option>
                              </select>
                            </div>
                            {t.exactDateRequired && (
                              <div>
                                <label className="text-xs font-semibold">Specific Date</label>
                                <input type="date" value={t.specificDate||''} onChange={(e)=>{
                                  const sel=new Date(e.target.value);
                                  const ws=getMondayOfWeek(t.startWeek);
                                  const we=calculateEndDate(ws,5,'days');
                                  if(sel<ws||sel>we){
                                    if(window.confirm(`Date outside Week ${t.startWeek}. Continue?`)) updateTask(t.id,'specificDate',e.target.value)
                                  } else updateTask(t.id,'specificDate',e.target.value);
                                }} className="w-full px-2 py-1 border rounded text-sm"/>
                              </div>
                            )}
                          </div>
                          <div>
                            <label className="text-xs font-semibold">Details</label>
                            <textarea value={t.details} onChange={(e)=>updateTask(t.id,'details',e.target.value)} rows="2" className="w-full px-2 py-1 border rounded text-sm mb-1"/>
                          </div>
                          <div>
                            <label className="text-xs font-semibold">Notes</label>
                            <textarea value={t.notes} onChange={(e)=>updateTask(t.id,'notes',e.target.value)} rows="2" className="w-full px-2 py-1 border rounded text-sm mb-1"/>
                          </div>
                          <button onClick={()=>deleteTask(t.id)} className="text-red-600 text-xs hover:text-red-800 flex items-center gap-1">üóëÔ∏è Delete</button>
                        </div>
                      ))}
                      <button onClick={addTask} className="flex items-center gap-2 bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 mt-1">‚ûï Add Task</button>
                    </div>
                  ))}
                </div>
              )}

              {/* Step 5 - Calendar */}
              {step === 5 && (
                <div className="space-y-2">
                  <h2 className="text-xl font-bold text-gray-800">Calendar View</h2>
                  <label className="block text-sm font-semibold text-gray-700">Filter by Task Type</label>
                  <select value={calendarFilter} onChange={(e)=>setCalendarFilter(e.target.value)} className="px-2 py-1 border rounded text-sm">
                    <option value="all">All Tasks</option>
                    {taskTypes.map(t=><option key={t} value={t}>{t}</option>)}
                  </select>
                  {renderCalendar()}
                </div>
              )}

              {/* Step 6 - Export */}
              {step === 6 && (
                <div className="text-center space-y-4">
                  <h2 className="text-xl font-bold text-gray-800">Export Project</h2>
                  <button onClick={exportToExcel} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">üìä Export to Excel</button>
                </div>
              )}

              {/* Navigation */}
              <div className="flex justify-between mt-4 pt-4 border-t">
                <button onClick={()=>setStep(Math.max(1,step-1))} disabled={step===1} className="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50">‚óÄÔ∏è Previous</button>
                <button onClick={()=>setStep(Math.min(6,step+1))} disabled={step===6 || (step===2 && tasks.length===0)} className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50">Next ‚ñ∂Ô∏è</button>
              </div>

            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<ProjectPlannerTool />, document.getElementById('root'));
  </script>
</body>
</html>
